name: iOS Build

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  ios-build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: Install CocoaPods
      run: |
        cd ios
        pod install --verbose

    - name: Build for iOS Simulator
      run: |
        cd ios
        xcodebuild -workspace ABCBankApp.xcworkspace \
                   -scheme ABCBankApp \
                   -configuration Debug \
                   -destination 'platform=iOS Simulator,name=iPhone 14' \
                   build

    - name: Build Archive (Release)
      run: |
        cd ios
        xcodebuild -workspace ABCBankApp.xcworkspace \
                   -scheme ABCBankApp \
                   -configuration Release \
                   -destination 'generic/platform=iOS' \
                   -archivePath ./build/ABCBankApp.xcarchive \
                   archive

    - name: Export IPA
      run: |
        cd ios
        xcodebuild -exportArchive \
                   -archivePath ./build/ABCBankApp.xcarchive \
                   -exportPath ./build \
                   -exportOptionsPlist exportOptions.plist

    - name: Upload IPA as artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: ABCBankApp-iOS
        path: ios/build/*.ipa
        retention-days: 30