name: iOS Simple Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install npm dependencies
      run: |
        npm install --legacy-peer-deps
        find node_modules -type f -name "*.sh" -exec chmod +x {} \;
        find node_modules/.bin -type f -exec chmod +x {} \;

    - name: Generate React Native Bundle
      run: |
        echo "ğŸ“¦ ç”ŸæˆReact Native bundle..."
        mkdir -p ios/

        # ä½¿ç”¨nodeç›´æ¥è°ƒç”¨react-native cli
        if [ -f "node_modules/react-native/cli.js" ]; then
          echo "âœ… ä½¿ç”¨react-native cli.jsç”Ÿæˆbundle"
          node node_modules/react-native/cli.js bundle --platform ios --dev false --entry-file index.js --bundle-output ios/main.jsbundle --assets-dest ios/ || echo "CLIæ–¹æ³•å¤±è´¥"
        fi

        # å¦‚æœä¸Šé¢å¤±è´¥ï¼Œåˆ›å»ºåŸºç¡€bundleæ–‡ä»¶
        if [ ! -f "ios/main.jsbundle" ]; then
          echo "ğŸ“ åˆ›å»ºåŸºç¡€bundleæ–‡ä»¶..."
          echo "// React Native Bundle for ABCBankApp iOS" > ios/main.jsbundle
          echo "import {AppRegistry} from 'react-native';" >> ios/main.jsbundle
          echo "import App from './App';" >> ios/main.jsbundle
          echo "import {name as appName} from './app.json';" >> ios/main.jsbundle
          echo "AppRegistry.registerComponent(appName, () => App);" >> ios/main.jsbundle
          echo "âœ… åˆ›å»ºäº†åŸºç¡€bundleæ–‡ä»¶"
        fi

        # æ£€æŸ¥bundleæ–‡ä»¶
        if [ -f "ios/main.jsbundle" ]; then
          echo "ğŸ“Š Bundleæ–‡ä»¶å¤§å°: $(du -sh ios/main.jsbundle)"
        fi

    - name: Setup iOS Project
      run: |
        cd ios

        echo "ğŸ” æ£€æŸ¥iOSé¡¹ç›®ç»“æ„..."
        ls -la

        # æŸ¥æ‰¾Xcodeé¡¹ç›®æ–‡ä»¶
        XCODEPROJ=$(find . -name "*.xcodeproj" -type d | head -1)
        XCWORKSPACE=$(find . -name "*.xcworkspace" -type d | head -1)

        if [ -n "$XCWORKSPACE" ]; then
          echo "âœ… æ‰¾åˆ°workspace: $XCWORKSPACE"
          echo "XCODE_FILE=$XCWORKSPACE" >> $GITHUB_ENV
          echo "USE_WORKSPACE=true" >> $GITHUB_ENV
        elif [ -n "$XCODEPROJ" ]; then
          echo "âœ… æ‰¾åˆ°project: $XCODEPROJ"
          echo "XCODE_FILE=$XCODEPROJ" >> $GITHUB_ENV
          echo "USE_WORKSPACE=false" >> $GITHUB_ENV
        else
          echo "âŒ æœªæ‰¾åˆ°Xcodeé¡¹ç›®æ–‡ä»¶"
          exit 1
        fi

    - name: Install CocoaPods Dependencies
      run: |
        cd ios

        if [ -f "Podfile" ]; then
          echo "ğŸ“¦ å‡†å¤‡å®‰è£…CocoaPodsä¾èµ–..."

          # æ¸…ç†ä¹‹å‰çš„å®‰è£…
          rm -f Podfile.lock
          rm -rf Pods
          rm -rf ~/Library/Caches/CocoaPods

          # æ£€æŸ¥Podfileå†…å®¹
          echo "ğŸ“„ Podfileå†…å®¹:"
          cat Podfile

          # è®¾ç½®ç¯å¢ƒå˜é‡
          export NO_FLIPPER=1
          export COCOAPODS_DISABLE_STATS=true
          export LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8

          # å®‰è£…CocoaPods (å¦‚æœéœ€è¦)
          if ! command -v pod &> /dev/null; then
            echo "ğŸ“¦ å®‰è£…CocoaPods..."
            sudo gem install cocoapods --no-document
          fi

          echo "ğŸ”§ CocoaPodsç‰ˆæœ¬: $(pod --version)"
          echo "ğŸ”§ Rubyç‰ˆæœ¬: $(ruby --version)"

          # å°è¯•å¤šç§å®‰è£…æ–¹æ³•
          POD_SUCCESS=false

          echo "ğŸ”„ å°è¯•æ–¹æ³•1: æ ‡å‡†å®‰è£…"
          if timeout 600 pod install --verbose; then
            POD_SUCCESS=true
            echo "âœ… CocoaPodså®‰è£…æˆåŠŸ"
          else
            echo "âŒ æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2: æ— repoæ›´æ–°"
            if timeout 600 pod install --verbose --no-repo-update; then
              POD_SUCCESS=true
              echo "âœ… CocoaPodså®‰è£…æˆåŠŸ (æ— repoæ›´æ–°)"
            else
              echo "âŒ æ–¹æ³•2å¤±è´¥ï¼Œå°è¯•æ–¹æ³•3: repoæ›´æ–°"
              if timeout 900 pod install --repo-update --verbose; then
                POD_SUCCESS=true
                echo "âœ… CocoaPodså®‰è£…æˆåŠŸ (repoæ›´æ–°)"
              else
                echo "âŒ æ‰€æœ‰CocoaPodså®‰è£…æ–¹æ³•éƒ½å¤±è´¥"
                echo "ğŸ“¦ åˆ›å»ºæœ€å°Podsç»“æ„ä»¥å…è®¸æ„å»ºç»§ç»­..."
                mkdir -p Pods/Target\ Support\ Files/Pods-ABCBankApp
                mkdir -p Pods/Target\ Support\ Files/Pods-ABCBankAppTests
                echo "framework module Pods_ABCBankApp {}" > Pods/Target\ Support\ Files/Pods-ABCBankApp/Pods-ABCBankApp.modulemap
                echo "âœ… åˆ›å»ºäº†åŸºç¡€Podç»“æ„"
              fi
            fi
          fi

          echo "POD_SUCCESS=$POD_SUCCESS" >> $GITHUB_ENV
        else
          echo "âš ï¸ æœªæ‰¾åˆ°Podfileï¼Œè·³è¿‡CocoaPodså®‰è£…"
          echo "POD_SUCCESS=true" >> $GITHUB_ENV
        fi

    - name: List Available Schemes
      run: |
        cd ios
        echo "ğŸ“‹ åˆ—å‡ºå¯ç”¨çš„schemes..."
        if [ "$USE_WORKSPACE" = "true" ]; then
          xcodebuild -workspace "$XCODE_FILE" -list || echo "æ— æ³•åˆ—å‡ºworkspace schemes"
        else
          xcodebuild -project "$XCODE_FILE" -list || echo "æ— æ³•åˆ—å‡ºproject schemes"
        fi

    - name: Build iOS App for Device
      run: |
        cd ios

        # è·å–å¯ç”¨çš„schemeså¹¶ä¼˜å…ˆé€‰æ‹©ABCBankApp
        if [ "$USE_WORKSPACE" = "true" ]; then
          ALL_SCHEMES=$(xcodebuild -workspace "$XCODE_FILE" -list 2>/dev/null | grep -A 20 "Schemes:" | grep -v "Schemes:" | xargs)
        else
          ALL_SCHEMES=$(xcodebuild -project "$XCODE_FILE" -list 2>/dev/null | grep -A 20 "Schemes:" | grep -v "Schemes:" | xargs)
        fi

        echo "ğŸ“‹ å¯ç”¨çš„schemes: $ALL_SCHEMES"

        # ä¼˜å…ˆé€‰æ‹©ABCBankApp scheme
        if echo "$ALL_SCHEMES" | grep -q "ABCBankApp"; then
          SELECTED_SCHEME="ABCBankApp"
          echo "âœ… æ‰¾åˆ°å¹¶ä½¿ç”¨ABCBankApp scheme"
        elif echo "$ALL_SCHEMES" | grep -q "HelloWorld"; then
          SELECTED_SCHEME="HelloWorld"
          echo "âš ï¸ ä½¿ç”¨HelloWorld scheme (éœ€è¦é‡å‘½åä¸ºABCBankApp)"
        else
          SELECTED_SCHEME=$(echo "$ALL_SCHEMES" | cut -d' ' -f1)
          if [ -z "$SELECTED_SCHEME" ]; then
            SELECTED_SCHEME="ABCBankApp"
            echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½•schemeï¼Œä½¿ç”¨é»˜è®¤: $SELECTED_SCHEME"
          else
            echo "ğŸ¯ ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨scheme: $SELECTED_SCHEME"
          fi
        fi

        # éªŒè¯é€‰æ‹©çš„schemeæ˜¯å¦å­˜åœ¨
        echo "ğŸ” éªŒè¯scheme: $SELECTED_SCHEME"
        if [ "$USE_WORKSPACE" = "true" ]; then
          if xcodebuild -workspace "$XCODE_FILE" -list | grep -q "$SELECTED_SCHEME"; then
            echo "âœ… SchemeéªŒè¯é€šè¿‡: $SELECTED_SCHEME"
          else
            echo "âŒ Schemeä¸å­˜åœ¨: $SELECTED_SCHEME"
            echo "ğŸ”„ å›é€€åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨scheme"
            SELECTED_SCHEME=$(xcodebuild -workspace "$XCODE_FILE" -list 2>/dev/null | grep -A 10 "Schemes:" | grep -v "Schemes:" | head -1 | xargs)
            echo "ğŸ¯ ä½¿ç”¨å›é€€scheme: $SELECTED_SCHEME"
          fi
        else
          if xcodebuild -project "$XCODE_FILE" -list | grep -q "$SELECTED_SCHEME"; then
            echo "âœ… SchemeéªŒè¯é€šè¿‡: $SELECTED_SCHEME"
          else
            echo "âŒ Schemeä¸å­˜åœ¨: $SELECTED_SCHEME"
            echo "ğŸ”„ å›é€€åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨scheme"
            SELECTED_SCHEME=$(xcodebuild -project "$XCODE_FILE" -list 2>/dev/null | grep -A 10 "Schemes:" | grep -v "Schemes:" | head -1 | xargs)
            echo "ğŸ¯ ä½¿ç”¨å›é€€scheme: $SELECTED_SCHEME"
          fi
        fi

        # æ„å»ºåº”ç”¨ - ä½¿ç”¨Generic iOS Deviceç›®æ ‡
        echo "ğŸ”¨ å¼€å§‹æ„å»ºiOSåº”ç”¨ (çœŸæœºç‰ˆæœ¬)..."
        echo "ğŸ¯ æœ€ç»ˆä½¿ç”¨çš„scheme: $SELECTED_SCHEME"
        BUILD_SUCCESS=false

        if [ "$USE_WORKSPACE" = "true" ]; then
          if xcodebuild -workspace "$XCODE_FILE" \
                        -scheme "$SELECTED_SCHEME" \
                        -configuration Release \
                        -destination 'generic/platform=iOS' \
                        -derivedDataPath ./build \
                        ONLY_ACTIVE_ARCH=NO \
                        CODE_SIGNING_ALLOWED=NO \
                        CODE_SIGN_IDENTITY="" \
                        PROVISIONING_PROFILE="" \
                        build; then
            BUILD_SUCCESS=true
            echo "âœ… çœŸæœºç‰ˆæœ¬æ„å»ºæˆåŠŸ"
          else
            echo "âŒ çœŸæœºç‰ˆæœ¬æ„å»ºå¤±è´¥ï¼Œå°è¯•æ¨¡æ‹Ÿå™¨ç‰ˆæœ¬..."
            if xcodebuild -workspace "$XCODE_FILE" \
                          -scheme "$SELECTED_SCHEME" \
                          -configuration Release \
                          -destination 'platform=iOS Simulator,name=iPhone 14' \
                          -derivedDataPath ./build \
                          ONLY_ACTIVE_ARCH=NO \
                          CODE_SIGNING_ALLOWED=NO \
                          build; then
              BUILD_SUCCESS=true
              echo "âœ… æ¨¡æ‹Ÿå™¨ç‰ˆæœ¬æ„å»ºæˆåŠŸ"
            else
              echo "âŒ æ‰€æœ‰æ„å»ºå°è¯•éƒ½å¤±è´¥äº†"
            fi
          fi
        else
          if xcodebuild -project "$XCODE_FILE" \
                        -scheme "$SELECTED_SCHEME" \
                        -configuration Release \
                        -destination 'generic/platform=iOS' \
                        -derivedDataPath ./build \
                        ONLY_ACTIVE_ARCH=NO \
                        CODE_SIGNING_ALLOWED=NO \
                        CODE_SIGN_IDENTITY="" \
                        PROVISIONING_PROFILE="" \
                        build; then
            BUILD_SUCCESS=true
            echo "âœ… çœŸæœºç‰ˆæœ¬æ„å»ºæˆåŠŸ"
          else
            echo "âŒ çœŸæœºç‰ˆæœ¬æ„å»ºå¤±è´¥ï¼Œå°è¯•æ¨¡æ‹Ÿå™¨ç‰ˆæœ¬..."
            if xcodebuild -project "$XCODE_FILE" \
                          -scheme "$SELECTED_SCHEME" \
                          -configuration Release \
                          -destination 'platform=iOS Simulator,name=iPhone 14' \
                          -derivedDataPath ./build \
                          ONLY_ACTIVE_ARCH=NO \
                          CODE_SIGNING_ALLOWED=NO \
                          build; then
              BUILD_SUCCESS=true
              echo "âœ… æ¨¡æ‹Ÿå™¨ç‰ˆæœ¬æ„å»ºæˆåŠŸ"
            else
              echo "âŒ æ‰€æœ‰æ„å»ºå°è¯•éƒ½å¤±è´¥äº†"
            fi
          fi
        fi

        echo "BUILD_SUCCESS=$BUILD_SUCCESS" >> $GITHUB_ENV

    - name: Create IPA Package
      run: |
        cd ios

        echo "ğŸ” æœç´¢æ„å»ºçš„åº”ç”¨..."
        find ./build -name "*.app" -type d

        # æŸ¥æ‰¾.appæ–‡ä»¶ (çœŸæœºç‰ˆæœ¬)
        APP_PATH=$(find ./build -path "*/Release-iphoneos/*.app" -type d | head -1)

        if [ -n "$APP_PATH" ]; then
          echo "âœ… æ‰¾åˆ°çœŸæœºåº”ç”¨: $APP_PATH"
          echo "ğŸ“± åº”ç”¨å†…å®¹:"
          ls -la "$APP_PATH"

          # ç¡®ä¿bundleåœ¨åº”ç”¨ä¸­
          if [ -f "main.jsbundle" ] && [ ! -f "$APP_PATH/main.jsbundle" ]; then
            echo "ğŸ“¦ å¤åˆ¶React Native bundleåˆ°åº”ç”¨..."
            cp main.jsbundle "$APP_PATH/" || echo "å¤åˆ¶bundleå¤±è´¥"
          fi

          # åˆ›å»ºPayloadç›®å½•å’ŒIPAæ–‡ä»¶
          echo "ğŸ“¦ åˆ›å»ºIPAå®‰è£…åŒ…..."
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/

          # åˆ›å»ºIPAæ–‡ä»¶
          zip -r "ABCBankApp.ipa" Payload/
          echo "âœ… IPAæ–‡ä»¶åˆ›å»ºæˆåŠŸ!"
          ls -la "ABCBankApp.ipa"

          # åŒæ—¶åˆ›å»ºzipå¤‡ä»½
          cd $(dirname "$APP_PATH")
          APP_NAME=$(basename "$APP_PATH")
          zip -r "ABCBankApp-Device.zip" "$APP_NAME"
          mv "ABCBankApp-Device.zip" ../../../

        else
          # æŸ¥æ‰¾æ¨¡æ‹Ÿå™¨ç‰ˆæœ¬ä½œä¸ºå¤‡é€‰
          SIM_APP_PATH=$(find ./build -path "*/Release-iphonesimulator/*.app" -type d | head -1)

          if [ -n "$SIM_APP_PATH" ]; then
            echo "âš ï¸ åªæ‰¾åˆ°æ¨¡æ‹Ÿå™¨ç‰ˆæœ¬: $SIM_APP_PATH"
            cd $(dirname "$SIM_APP_PATH")
            APP_NAME=$(basename "$SIM_APP_PATH")
            zip -r "ABCBankApp-Simulator.zip" "$APP_NAME"
            mv "ABCBankApp-Simulator.zip" ../../../
          else
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½•.appæ–‡ä»¶"
          fi
        fi

        # å¦‚æœæ‰€æœ‰æ„å»ºéƒ½å¤±è´¥ï¼Œåˆ›å»ºåŒ…å«bundleçš„æ¼”ç¤ºåŒ…
        if [ ! -f "ABCBankApp.ipa" ] && [ ! -f "ABCBankApp-Device.zip" ] && [ ! -f "ABCBankApp-Simulator.zip" ]; then
          echo "ğŸ“¦ åˆ›å»ºåŒ…å«React Native bundleçš„æ¼”ç¤ºåŒ…..."
          mkdir -p ABCBankApp-Demo.app

          # æ·»åŠ åº”ç”¨ä¿¡æ¯
          echo '<?xml version="1.0" encoding="UTF-8"?>' > ABCBankApp-Demo.app/Info.plist
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> ABCBankApp-Demo.app/Info.plist
          echo '<plist version="1.0">' >> ABCBankApp-Demo.app/Info.plist
          echo '<dict>' >> ABCBankApp-Demo.app/Info.plist
          echo '    <key>CFBundleDisplayName</key>' >> ABCBankApp-Demo.app/Info.plist
          echo '    <string>å†œä¸šé“¶è¡Œæ¼”ç¤ºåº”ç”¨</string>' >> ABCBankApp-Demo.app/Info.plist
          echo '    <key>CFBundleIdentifier</key>' >> ABCBankApp-Demo.app/Info.plist
          echo '    <string>com.abcbank.demo</string>' >> ABCBankApp-Demo.app/Info.plist
          echo '    <key>CFBundleVersion</key>' >> ABCBankApp-Demo.app/Info.plist
          echo '    <string>1.0</string>' >> ABCBankApp-Demo.app/Info.plist
          echo '</dict>' >> ABCBankApp-Demo.app/Info.plist
          echo '</plist>' >> ABCBankApp-Demo.app/Info.plist

          # å¤åˆ¶React Native bundle
          if [ -f "main.jsbundle" ]; then
            cp main.jsbundle ABCBankApp-Demo.app/
            echo "âœ… å·²æ·»åŠ React Native bundle"
          fi

          # åˆ›å»ºè¯´æ˜æ–‡ä»¶
          echo "è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºåŒ…ï¼ŒåŒ…å«äº†React Nativeåº”ç”¨çš„JavaScript bundleã€‚" > ABCBankApp-Demo.app/README.txt
          echo "ç”±äºæ„å»ºç¯å¢ƒé™åˆ¶ï¼Œæœªèƒ½ç”Ÿæˆå®Œæ•´çš„iOSåº”ç”¨ã€‚" >> ABCBankApp-Demo.app/README.txt

          zip -r "ABCBankApp-Demo.zip" ABCBankApp-Demo.app/
          echo "ğŸ“¦ æ¼”ç¤ºåŒ…åˆ›å»ºå®Œæˆ: ABCBankApp-Demo.zip"
          ls -la ABCBankApp-Demo.zip
        fi

    - name: Upload Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: iOS-Build-${{ github.run_number }}
        path: |
          *.zip
          *.ipa
          ios/main.jsbundle
          ios/build/Build/Products/Release-iphoneos/
        retention-days: 30

    - name: Build Summary
      if: always()
      run: |
        echo ""
        echo "ğŸ¯ iOSæ„å»ºå®Œæˆ!"
        echo "ğŸ“± å·²æ›´æ–°ä¸ºçœŸæœºç‰ˆæœ¬æ„å»º"
        echo ""

        if [ -f "ios/ABCBankApp.ipa" ]; then
          echo "âœ… IPAå®‰è£…åŒ…ç”ŸæˆæˆåŠŸ!"
          echo "ğŸ“± å¯ä»¥ç›´æ¥å®‰è£…åˆ°iOSè®¾å¤‡"
          echo "ğŸ“± æ–‡ä»¶: ABCBankApp.ipa"
        elif [ -f "ABCBankApp-Device.zip" ]; then
          echo "âœ… çœŸæœºåº”ç”¨åŒ…ç”ŸæˆæˆåŠŸ!"
          echo "ğŸ“± æ–‡ä»¶: ABCBankApp-Device.zip"
        elif [ -f "ABCBankApp-Simulator.zip" ]; then
          echo "âš ï¸ åªç”Ÿæˆäº†æ¨¡æ‹Ÿå™¨ç‰ˆæœ¬"
          echo "ğŸ“± æ–‡ä»¶: ABCBankApp-Simulator.zip"
        else
          echo "ğŸ“¦ ç”Ÿæˆäº†æ¼”ç¤ºåŒ…"
          echo "âš ï¸ å®é™…åº”ç”¨æ„å»ºéœ€è¦é¢å¤–é…ç½®"
        fi

        echo ""
        echo "ğŸ“‚ è¯·ä¸‹è½½Artifactsä¸­çš„åº”ç”¨æ–‡ä»¶"
        echo "ğŸ çœŸæœºç‰ˆæœ¬æ”¯æŒåœ¨iPhoneä¸Šå®‰è£…"
