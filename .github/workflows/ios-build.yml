name: Build iOS App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci --legacy-peer-deps || npm install --legacy-peer-deps

    - name: Setup Ruby and Bundler
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: false

    - name: Install CocoaPods (No Flipper)
      env:
        NO_FLIPPER: 1
      run: |
        cd ios
        # 删除可能存在的锁定文件和缓存
        rm -f Podfile.lock
        rm -rf Pods

        echo "🚫 禁用Flipper以避免boost下载问题"
        echo "NO_FLIPPER=1" >> $GITHUB_ENV

        # 显示项目结构
        echo "📂 iOS project structure:"
        ls -la

        # 使用系统CocoaPods直接安装
        sudo gem install cocoapods
        pod --version

        # 不更新repo，使用本地缓存
        echo "📦 使用NO_FLIPPER环境变量安装依赖..."
        pod install --verbose

    - name: Build iOS App
      env:
        NO_FLIPPER: 1
      run: |
        cd ios
        # 检查workspace是否存在
        if [ -f "ABCBankApp.xcworkspace" ]; then
          echo "Using xcworkspace"
          xcodebuild -workspace ABCBankApp.xcworkspace \
                     -scheme HelloWorld \
                     -configuration Release \
                     -destination 'platform=iOS Simulator,name=iPhone 14' \
                     -derivedDataPath ./build \
                     clean build
        else
          echo "Using xcodeproj"
          xcodebuild -project ABCBankApp.xcodeproj \
                     -scheme HelloWorld \
                     -configuration Release \
                     -destination 'platform=iOS Simulator,name=iPhone 14' \
                     -derivedDataPath ./build \
                     clean build
        fi

    - name: Package App
      run: |
        cd ios/build/Build/Products/Release-iphonesimulator/
        if [ -d "HelloWorld.app" ]; then
          zip -r ABCBankApp-Simulator.zip HelloWorld.app
          echo "✅ App packaged successfully"
          ls -la ABCBankApp-Simulator.zip
        else
          echo "❌ App build failed - .app file not found"
          echo "Available files:"
          ls -la
          exit 1
        fi

    - name: Upload iOS App
      uses: actions/upload-artifact@v4
      with:
        name: iOS-App-${{ github.run_number }}
        path: ios/build/Build/Products/Release-iphonesimulator/ABCBankApp-Simulator.zip
        retention-days: 30

    - name: Build Summary
      run: |
        echo "✅ iOS构建完成!"
        echo "📱 应用已打包为模拟器版本"
        echo "📂 下载: Actions → 本次构建 → Artifacts"
