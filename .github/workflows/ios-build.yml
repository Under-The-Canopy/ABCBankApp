name: Build iOS App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci --legacy-peer-deps || npm install --legacy-peer-deps

    - name: Setup Ruby and Bundler
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: false

    - name: Install CocoaPods (Enhanced Method)
      run: |
        cd ios
        # 删除可能存在的锁定文件和缓存
        rm -f Podfile.lock
        rm -rf Pods
        rm -rf ~/Library/Caches/CocoaPods || true

        # 显示项目结构
        echo "📂 iOS project structure:"
        ls -la

        # 使用系统CocoaPods直接安装
        sudo gem install cocoapods
        pod --version

        # 清理CocoaPods缓存
        pod cache clean --all

        # 更新repo
        pod repo update --verbose

        # 尝试安装，如果失败则重试
        for i in 1 2 3; do
          echo "🔄 CocoaPods安装尝试 #$i"
          if pod install --verbose --clean-install; then
            echo "✅ CocoaPods安装成功"
            break
          else
            echo "❌ 安装失败，清理缓存后重试..."
            pod cache clean --all
            rm -rf Pods
            if [ $i -eq 3 ]; then
              echo "💥 CocoaPods安装失败，尝试使用--repo-update"
              pod install --verbose --repo-update
            fi
            sleep 10
          fi
        done

    - name: Build iOS App
      run: |
        cd ios
        # 检查workspace是否存在
        if [ -f "ABCBankApp.xcworkspace" ]; then
          echo "Using xcworkspace"
          xcodebuild -workspace ABCBankApp.xcworkspace \
                     -scheme HelloWorld \
                     -configuration Release \
                     -destination 'platform=iOS Simulator,name=iPhone 14' \
                     -derivedDataPath ./build \
                     clean build
        else
          echo "Using xcodeproj"
          xcodebuild -project ABCBankApp.xcodeproj \
                     -scheme HelloWorld \
                     -configuration Release \
                     -destination 'platform=iOS Simulator,name=iPhone 14' \
                     -derivedDataPath ./build \
                     clean build
        fi

    - name: Package App
      run: |
        cd ios/build/Build/Products/Release-iphonesimulator/
        if [ -d "HelloWorld.app" ]; then
          zip -r ABCBankApp-Simulator.zip HelloWorld.app
          echo "✅ App packaged successfully"
          ls -la ABCBankApp-Simulator.zip
        else
          echo "❌ App build failed - .app file not found"
          echo "Available files:"
          ls -la
          exit 1
        fi

    - name: Upload iOS App
      uses: actions/upload-artifact@v4
      with:
        name: iOS-App-${{ github.run_number }}
        path: ios/build/Build/Products/Release-iphonesimulator/ABCBankApp-Simulator.zip
        retention-days: 30

    - name: Build Summary
      run: |
        echo "✅ iOS构建完成!"
        echo "📱 应用已打包为模拟器版本"
        echo "📂 下载: Actions → 本次构建 → Artifacts"
