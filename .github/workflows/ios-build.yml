name: Build iOS App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci --legacy-peer-deps || npm install --legacy-peer-deps

    - name: Setup Ruby and Bundler
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: false

    - name: Install CocoaPods (No Flipper)
      env:
        NO_FLIPPER: 1
      run: |
        cd ios
        # åˆ é™¤å¯èƒ½å­˜åœ¨çš„é”å®šæ–‡ä»¶å’Œç¼“å­˜
        rm -f Podfile.lock
        rm -rf Pods

        echo "ğŸš« ç¦ç”¨Flipperä»¥é¿å…boostä¸‹è½½é—®é¢˜"
        echo "NO_FLIPPER=1" >> $GITHUB_ENV

        # æ˜¾ç¤ºé¡¹ç›®ç»“æ„
        echo "ğŸ“‚ iOS project structure:"
        ls -la

        # ä½¿ç”¨ç³»ç»ŸCocoaPodsç›´æ¥å®‰è£…
        sudo gem install cocoapods
        pod --version

        # ä¸æ›´æ–°repoï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜
        echo "ğŸ“¦ ä½¿ç”¨NO_FLIPPERç¯å¢ƒå˜é‡å®‰è£…ä¾èµ–..."
        pod install --verbose

    - name: Build iOS App
      env:
        NO_FLIPPER: 1
      run: |
        cd ios
        # æ£€æŸ¥workspaceæ˜¯å¦å­˜åœ¨
        if [ -f "ABCBankApp.xcworkspace" ]; then
          echo "Using xcworkspace"
          xcodebuild -workspace ABCBankApp.xcworkspace \
                     -scheme HelloWorld \
                     -configuration Release \
                     -destination 'platform=iOS Simulator,name=iPhone 14' \
                     -derivedDataPath ./build \
                     clean build
        else
          echo "Using xcodeproj"
          xcodebuild -project ABCBankApp.xcodeproj \
                     -scheme HelloWorld \
                     -configuration Release \
                     -destination 'platform=iOS Simulator,name=iPhone 14' \
                     -derivedDataPath ./build \
                     clean build
        fi

    - name: Package App
      run: |
        cd ios/build/Build/Products/Release-iphonesimulator/
        if [ -d "HelloWorld.app" ]; then
          zip -r ABCBankApp-Simulator.zip HelloWorld.app
          echo "âœ… App packaged successfully"
          ls -la ABCBankApp-Simulator.zip
        else
          echo "âŒ App build failed - .app file not found"
          echo "Available files:"
          ls -la
          exit 1
        fi

    - name: Upload iOS App
      uses: actions/upload-artifact@v4
      with:
        name: iOS-App-${{ github.run_number }}
        path: ios/build/Build/Products/Release-iphonesimulator/ABCBankApp-Simulator.zip
        retention-days: 30

    - name: Build Summary
      run: |
        echo "âœ… iOSæ„å»ºå®Œæˆ!"
        echo "ğŸ“± åº”ç”¨å·²æ‰“åŒ…ä¸ºæ¨¡æ‹Ÿå™¨ç‰ˆæœ¬"
        echo "ğŸ“‚ ä¸‹è½½: Actions â†’ æœ¬æ¬¡æ„å»º â†’ Artifacts"
