name: Build iOS App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci --legacy-peer-deps || npm install --legacy-peer-deps

    - name: Setup Ruby and Bundler
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: false

    - name: Install CocoaPods (Enhanced Method)
      run: |
        cd ios
        # åˆ é™¤å¯èƒ½å­˜åœ¨çš„é”å®šæ–‡ä»¶å’Œç¼“å­˜
        rm -f Podfile.lock
        rm -rf Pods
        rm -rf ~/Library/Caches/CocoaPods || true

        # æ˜¾ç¤ºé¡¹ç›®ç»“æ„
        echo "ğŸ“‚ iOS project structure:"
        ls -la

        # ä½¿ç”¨ç³»ç»ŸCocoaPodsç›´æ¥å®‰è£…
        sudo gem install cocoapods
        pod --version

        # æ¸…ç†CocoaPodsç¼“å­˜
        pod cache clean --all

        # æ›´æ–°repo
        pod repo update --verbose

        # å°è¯•å®‰è£…ï¼Œå¦‚æœå¤±è´¥åˆ™é‡è¯•
        for i in 1 2 3; do
          echo "ğŸ”„ CocoaPodså®‰è£…å°è¯• #$i"
          if pod install --verbose --clean-install; then
            echo "âœ… CocoaPodså®‰è£…æˆåŠŸ"
            break
          else
            echo "âŒ å®‰è£…å¤±è´¥ï¼Œæ¸…ç†ç¼“å­˜åé‡è¯•..."
            pod cache clean --all
            rm -rf Pods
            if [ $i -eq 3 ]; then
              echo "ğŸ’¥ CocoaPodså®‰è£…å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨--repo-update"
              pod install --verbose --repo-update
            fi
            sleep 10
          fi
        done

    - name: Build iOS App
      run: |
        cd ios
        # æ£€æŸ¥workspaceæ˜¯å¦å­˜åœ¨
        if [ -f "ABCBankApp.xcworkspace" ]; then
          echo "Using xcworkspace"
          xcodebuild -workspace ABCBankApp.xcworkspace \
                     -scheme HelloWorld \
                     -configuration Release \
                     -destination 'platform=iOS Simulator,name=iPhone 14' \
                     -derivedDataPath ./build \
                     clean build
        else
          echo "Using xcodeproj"
          xcodebuild -project ABCBankApp.xcodeproj \
                     -scheme HelloWorld \
                     -configuration Release \
                     -destination 'platform=iOS Simulator,name=iPhone 14' \
                     -derivedDataPath ./build \
                     clean build
        fi

    - name: Package App
      run: |
        cd ios/build/Build/Products/Release-iphonesimulator/
        if [ -d "HelloWorld.app" ]; then
          zip -r ABCBankApp-Simulator.zip HelloWorld.app
          echo "âœ… App packaged successfully"
          ls -la ABCBankApp-Simulator.zip
        else
          echo "âŒ App build failed - .app file not found"
          echo "Available files:"
          ls -la
          exit 1
        fi

    - name: Upload iOS App
      uses: actions/upload-artifact@v4
      with:
        name: iOS-App-${{ github.run_number }}
        path: ios/build/Build/Products/Release-iphonesimulator/ABCBankApp-Simulator.zip
        retention-days: 30

    - name: Build Summary
      run: |
        echo "âœ… iOSæ„å»ºå®Œæˆ!"
        echo "ğŸ“± åº”ç”¨å·²æ‰“åŒ…ä¸ºæ¨¡æ‹Ÿå™¨ç‰ˆæœ¬"
        echo "ğŸ“‚ ä¸‹è½½: Actions â†’ æœ¬æ¬¡æ„å»º â†’ Artifacts"
