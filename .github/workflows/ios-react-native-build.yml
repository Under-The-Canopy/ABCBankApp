name: React Native iOS Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install npm dependencies
      run: npm install --legacy-peer-deps

    - name: Generate React Native Bundle
      run: |
        echo "ğŸ“¦ ç”ŸæˆReact Native bundle..."
        npx react-native bundle \
          --platform ios \
          --dev false \
          --entry-file index.js \
          --bundle-output ios/main.jsbundle \
          --assets-dest ios/

    - name: Setup CocoaPods with NO_FLIPPER
      env:
        NO_FLIPPER: 1
      run: |
        cd ios
        rm -f Podfile.lock
        rm -rf Pods

        # ä¿®æ”¹Podfileä»¥ç¦ç”¨Flipper
        if [ -f "Podfile" ]; then
          sed -i '' 's/:flipper_configuration => flipper_config/:flipper_configuration => FlipperConfiguration.disabled/g' Podfile || true
        fi

        sudo gem install cocoapods
        pod install --verbose

    - name: Build iOS App
      run: |
        cd ios

        # è®¾ç½®æ„å»ºç¯å¢ƒ
        export NO_FLIPPER=1
        export RCT_NO_LAUNCH_PACKAGER=1

        # æ„å»ºåº”ç”¨
        xcodebuild -workspace ABCBankApp.xcworkspace \
                   -scheme HelloWorld \
                   -configuration Release \
                   -destination 'platform=iOS Simulator,name=iPhone 14' \
                   -derivedDataPath ./build \
                   ONLY_ACTIVE_ARCH=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   clean build

    - name: Package Real App
      run: |
        cd ios

        # æŸ¥æ‰¾æ„å»ºçš„åº”ç”¨
        APP_PATH=$(find ./build -name "*.app" -type d | head -1)

        if [ -n "$APP_PATH" ]; then
          echo "âœ… æ‰¾åˆ°å®Œæ•´åº”ç”¨: $APP_PATH"

          # æ£€æŸ¥åº”ç”¨å†…å®¹
          echo "ğŸ“± åº”ç”¨å†…å®¹:"
          ls -la "$APP_PATH"

          # æ‰“åŒ…åº”ç”¨
          cd $(dirname "$APP_PATH")
          zip -r ABCBankApp-Complete.zip *.app

          echo "ğŸ“¦ å®Œæ•´åº”ç”¨æ‰“åŒ…å®Œæˆ"
          ls -la ABCBankApp-Complete.zip

          # ç§»åŠ¨åˆ°æ ¹ç›®å½•
          mv ABCBankApp-Complete.zip ../../../
        else
          echo "âŒ æœªæ‰¾åˆ°å®Œæ•´çš„.appæ–‡ä»¶"
          echo "æ„å»ºç›®å½•å†…å®¹ï¼š"
          find ./build -type f -name "*" | head -20
        fi

    - name: Upload Complete iOS App
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: iOS-ReactNative-App-${{ github.run_number }}
        path: |
          ABCBankApp-Complete.zip
          ios/main.jsbundle
        retention-days: 30

    - name: Build Summary
      if: always()
      run: |
        echo "ğŸ¯ React Native iOSæ„å»ºå®Œæˆ!"
        echo "ğŸ“± è¿™æ¬¡æ„å»ºåŒ…å«äº†å®Œæ•´çš„React Nativeåº”ç”¨"
        echo "ğŸ“‚ ä¸‹è½½Artifactsä¸­çš„ABCBankApp-Complete.zip"
        echo ""
        if [ -f "ABCBankApp-Complete.zip" ]; then
          echo "âœ… æˆåŠŸæ„å»ºå®Œæ•´iOSåº”ç”¨!"
          echo "ğŸ“± åº”ç”¨åŒ…å«React Native bundleå’Œæ‰€æœ‰å¿…è¦æ–‡ä»¶"
        else
          echo "âš ï¸ æ„å»ºå¯èƒ½ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi