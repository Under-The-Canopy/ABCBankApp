name: React Native iOS Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install npm dependencies
      run: npm install --legacy-peer-deps

    - name: Generate React Native Bundle
      run: |
        echo "📦 生成React Native bundle..."
        npx react-native bundle \
          --platform ios \
          --dev false \
          --entry-file index.js \
          --bundle-output ios/main.jsbundle \
          --assets-dest ios/

    - name: Setup CocoaPods with NO_FLIPPER
      env:
        NO_FLIPPER: 1
      run: |
        cd ios
        rm -f Podfile.lock
        rm -rf Pods

        # 修改Podfile以禁用Flipper
        if [ -f "Podfile" ]; then
          sed -i '' 's/:flipper_configuration => flipper_config/:flipper_configuration => FlipperConfiguration.disabled/g' Podfile || true
        fi

        sudo gem install cocoapods
        pod install --verbose

    - name: Build iOS App
      run: |
        cd ios

        # 设置构建环境
        export NO_FLIPPER=1
        export RCT_NO_LAUNCH_PACKAGER=1

        # 构建应用
        xcodebuild -workspace ABCBankApp.xcworkspace \
                   -scheme HelloWorld \
                   -configuration Release \
                   -destination 'platform=iOS Simulator,name=iPhone 14' \
                   -derivedDataPath ./build \
                   ONLY_ACTIVE_ARCH=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   clean build

    - name: Package Real App
      run: |
        cd ios

        # 查找构建的应用
        APP_PATH=$(find ./build -name "*.app" -type d | head -1)

        if [ -n "$APP_PATH" ]; then
          echo "✅ 找到完整应用: $APP_PATH"

          # 检查应用内容
          echo "📱 应用内容:"
          ls -la "$APP_PATH"

          # 打包应用
          cd $(dirname "$APP_PATH")
          zip -r ABCBankApp-Complete.zip *.app

          echo "📦 完整应用打包完成"
          ls -la ABCBankApp-Complete.zip

          # 移动到根目录
          mv ABCBankApp-Complete.zip ../../../
        else
          echo "❌ 未找到完整的.app文件"
          echo "构建目录内容："
          find ./build -type f -name "*" | head -20
        fi

    - name: Upload Complete iOS App
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: iOS-ReactNative-App-${{ github.run_number }}
        path: |
          ABCBankApp-Complete.zip
          ios/main.jsbundle
        retention-days: 30

    - name: Build Summary
      if: always()
      run: |
        echo "🎯 React Native iOS构建完成!"
        echo "📱 这次构建包含了完整的React Native应用"
        echo "📂 下载Artifacts中的ABCBankApp-Complete.zip"
        echo ""
        if [ -f "ABCBankApp-Complete.zip" ]; then
          echo "✅ 成功构建完整iOS应用!"
          echo "📱 应用包含React Native bundle和所有必要文件"
        else
          echo "⚠️ 构建可能不完整，请检查日志"
        fi