name: Build Android APK

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install npm dependencies
      run: npm install --legacy-peer-deps

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Setup Gradle Wrapper
      run: |
        cd android
        # 创建简单的gradlew脚本
        echo '#!/bin/bash' > gradlew
        echo 'exec gradle "$@"' >> gradlew
        chmod +x gradlew

    - name: Generate React Native Bundle
      run: |
        echo "📦 生成Android React Native bundle..."
        npx react-native bundle \
          --platform android \
          --dev false \
          --entry-file index.js \
          --bundle-output android/app/src/main/assets/index.android.bundle \
          --assets-dest android/app/src/main/res/

    - name: Build Debug APK
      run: |
        cd android
        echo "🔨 构建Debug APK..."
        ./gradlew assembleDebug --no-daemon

    - name: Build Release APK
      run: |
        cd android
        echo "🔨 构建Release APK..."
        ./gradlew assembleRelease --no-daemon

    - name: Find and Package APKs
      run: |
        echo "🔍 查找生成的APK文件..."
        find android -name "*.apk" -type f

        # 创建打包目录
        mkdir -p apk-output

        # 复制APK文件
        if [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
          cp "android/app/build/outputs/apk/debug/app-debug.apk" "apk-output/ABCBankApp-debug.apk"
          echo "✅ Debug APK已复制"
        fi

        if [ -f "android/app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          cp "android/app/build/outputs/apk/release/app-release-unsigned.apk" "apk-output/ABCBankApp-release-unsigned.apk"
          echo "✅ Release APK已复制"
        fi

        # 显示APK信息
        echo "📱 APK文件信息:"
        ls -la apk-output/

        # 显示APK大小
        for apk in apk-output/*.apk; do
          if [ -f "$apk" ]; then
            echo "📦 $(basename "$apk"): $(du -sh "$apk" | cut -f1)"
          fi
        done

    - name: Create App Info
      run: |
        echo "📱 Android应用构建信息:" > build_info.txt
        echo "构建时间: $(date)" >> build_info.txt
        echo "平台: Android" >> build_info.txt
        echo "React Native版本: $(npx react-native --version)" >> build_info.txt
        echo "Node.js版本: $(node --version)" >> build_info.txt
        echo "Java版本: $(java -version 2>&1 | head -1)" >> build_info.txt
        echo "" >> build_info.txt

        if [ -f "apk-output/ABCBankApp-debug.apk" ]; then
          echo "✅ Debug APK: 构建成功" >> build_info.txt
          echo "   大小: $(du -sh apk-output/ABCBankApp-debug.apk | cut -f1)" >> build_info.txt
        fi

        if [ -f "apk-output/ABCBankApp-release-unsigned.apk" ]; then
          echo "✅ Release APK: 构建成功" >> build_info.txt
          echo "   大小: $(du -sh apk-output/ABCBankApp-release-unsigned.apk | cut -f1)" >> build_info.txt
          echo "   注意: 这是未签名版本，需要手动安装" >> build_info.txt
        fi

        cat build_info.txt

    - name: Upload Android APKs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: Android-APKs-${{ github.run_number }}
        path: |
          apk-output/*.apk
          build_info.txt
        retention-days: 30

    - name: Build Summary
      if: always()
      run: |
        echo ""
        echo "🎯 Android构建完成!"
        echo "📱 生成了中国农业银行Android应用"
        echo "📂 检查Artifacts获取APK文件:"
        echo ""

        if [ -f "apk-output/ABCBankApp-debug.apk" ]; then
          echo "✅ ABCBankApp-debug.apk - 可直接安装的调试版本"
        fi

        if [ -f "apk-output/ABCBankApp-release-unsigned.apk" ]; then
          echo "✅ ABCBankApp-release-unsigned.apk - 发布版本(未签名)"
        fi

        echo ""
        echo "📲 安装说明:"
        echo "1. 下载APK文件"
        echo "2. 在Android设备上启用'未知来源'安装"
        echo "3. 直接安装APK文件"
        echo ""
        echo "🔧 推荐使用debug版本进行测试!"