name: Build Android APK

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install npm dependencies
      run: npm install --legacy-peer-deps

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Setup Gradle Wrapper
      run: |
        cd android
        # åˆ›å»ºç®€å•çš„gradlewè„šæœ¬
        echo '#!/bin/bash' > gradlew
        echo 'exec gradle "$@"' >> gradlew
        chmod +x gradlew

    - name: Generate React Native Bundle
      run: |
        echo "ğŸ“¦ ç”ŸæˆAndroid React Native bundle..."
        npx react-native bundle \
          --platform android \
          --dev false \
          --entry-file index.js \
          --bundle-output android/app/src/main/assets/index.android.bundle \
          --assets-dest android/app/src/main/res/

    - name: Build Debug APK
      run: |
        cd android
        echo "ğŸ”¨ æ„å»ºDebug APK..."
        ./gradlew assembleDebug --no-daemon

    - name: Build Release APK
      run: |
        cd android
        echo "ğŸ”¨ æ„å»ºRelease APK..."
        ./gradlew assembleRelease --no-daemon

    - name: Find and Package APKs
      run: |
        echo "ğŸ” æŸ¥æ‰¾ç”Ÿæˆçš„APKæ–‡ä»¶..."
        find android -name "*.apk" -type f

        # åˆ›å»ºæ‰“åŒ…ç›®å½•
        mkdir -p apk-output

        # å¤åˆ¶APKæ–‡ä»¶
        if [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
          cp "android/app/build/outputs/apk/debug/app-debug.apk" "apk-output/ABCBankApp-debug.apk"
          echo "âœ… Debug APKå·²å¤åˆ¶"
        fi

        if [ -f "android/app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          cp "android/app/build/outputs/apk/release/app-release-unsigned.apk" "apk-output/ABCBankApp-release-unsigned.apk"
          echo "âœ… Release APKå·²å¤åˆ¶"
        fi

        # æ˜¾ç¤ºAPKä¿¡æ¯
        echo "ğŸ“± APKæ–‡ä»¶ä¿¡æ¯:"
        ls -la apk-output/

        # æ˜¾ç¤ºAPKå¤§å°
        for apk in apk-output/*.apk; do
          if [ -f "$apk" ]; then
            echo "ğŸ“¦ $(basename "$apk"): $(du -sh "$apk" | cut -f1)"
          fi
        done

    - name: Create App Info
      run: |
        echo "ğŸ“± Androidåº”ç”¨æ„å»ºä¿¡æ¯:" > build_info.txt
        echo "æ„å»ºæ—¶é—´: $(date)" >> build_info.txt
        echo "å¹³å°: Android" >> build_info.txt
        echo "React Nativeç‰ˆæœ¬: $(npx react-native --version)" >> build_info.txt
        echo "Node.jsç‰ˆæœ¬: $(node --version)" >> build_info.txt
        echo "Javaç‰ˆæœ¬: $(java -version 2>&1 | head -1)" >> build_info.txt
        echo "" >> build_info.txt

        if [ -f "apk-output/ABCBankApp-debug.apk" ]; then
          echo "âœ… Debug APK: æ„å»ºæˆåŠŸ" >> build_info.txt
          echo "   å¤§å°: $(du -sh apk-output/ABCBankApp-debug.apk | cut -f1)" >> build_info.txt
        fi

        if [ -f "apk-output/ABCBankApp-release-unsigned.apk" ]; then
          echo "âœ… Release APK: æ„å»ºæˆåŠŸ" >> build_info.txt
          echo "   å¤§å°: $(du -sh apk-output/ABCBankApp-release-unsigned.apk | cut -f1)" >> build_info.txt
          echo "   æ³¨æ„: è¿™æ˜¯æœªç­¾åç‰ˆæœ¬ï¼Œéœ€è¦æ‰‹åŠ¨å®‰è£…" >> build_info.txt
        fi

        cat build_info.txt

    - name: Upload Android APKs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: Android-APKs-${{ github.run_number }}
        path: |
          apk-output/*.apk
          build_info.txt
        retention-days: 30

    - name: Build Summary
      if: always()
      run: |
        echo ""
        echo "ğŸ¯ Androidæ„å»ºå®Œæˆ!"
        echo "ğŸ“± ç”Ÿæˆäº†ä¸­å›½å†œä¸šé“¶è¡ŒAndroidåº”ç”¨"
        echo "ğŸ“‚ æ£€æŸ¥Artifactsè·å–APKæ–‡ä»¶:"
        echo ""

        if [ -f "apk-output/ABCBankApp-debug.apk" ]; then
          echo "âœ… ABCBankApp-debug.apk - å¯ç›´æ¥å®‰è£…çš„è°ƒè¯•ç‰ˆæœ¬"
        fi

        if [ -f "apk-output/ABCBankApp-release-unsigned.apk" ]; then
          echo "âœ… ABCBankApp-release-unsigned.apk - å‘å¸ƒç‰ˆæœ¬(æœªç­¾å)"
        fi

        echo ""
        echo "ğŸ“² å®‰è£…è¯´æ˜:"
        echo "1. ä¸‹è½½APKæ–‡ä»¶"
        echo "2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨'æœªçŸ¥æ¥æº'å®‰è£…"
        echo "3. ç›´æ¥å®‰è£…APKæ–‡ä»¶"
        echo ""
        echo "ğŸ”§ æ¨èä½¿ç”¨debugç‰ˆæœ¬è¿›è¡Œæµ‹è¯•!"