name: iOS Auto-Detect Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install npm dependencies
      run: npm install --legacy-peer-deps

    - name: Generate React Native Bundle
      run: |
        echo "ğŸ“¦ ç”ŸæˆReact Native bundle..."
        npx react-native bundle \
          --platform ios \
          --dev false \
          --entry-file index.js \
          --bundle-output ios/main.jsbundle \
          --assets-dest ios/

    - name: Auto-detect iOS Project Configuration
      run: |
        cd ios

        echo "ğŸ” æ£€æŸ¥iOSé¡¹ç›®ç»“æ„..."
        ls -la

        echo ""
        echo "ğŸ“‹ æŸ¥æ‰¾Xcodeé¡¹ç›®æ–‡ä»¶..."
        find . -name "*.xcodeproj" -type d
        find . -name "*.xcworkspace" -type d

        echo ""
        echo "ğŸ“± æ£€æŸ¥å¯ç”¨çš„schemes..."

        # æ£€æŸ¥workspace
        if [ -f "ABCBankApp.xcworkspace/contents.xcworkspacedata" ]; then
          echo "âœ… æ‰¾åˆ°workspace: ABCBankApp.xcworkspace"
          xcodebuild -workspace ABCBankApp.xcworkspace -list
          echo "USE_WORKSPACE=true" >> $GITHUB_ENV
        elif [ -f "ABCBankApp.xcodeproj/project.pbxproj" ]; then
          echo "âœ… æ‰¾åˆ°project: ABCBankApp.xcodeproj"
          xcodebuild -project ABCBankApp.xcodeproj -list
          echo "USE_WORKSPACE=false" >> $GITHUB_ENV
        else
          echo "âŒ æœªæ‰¾åˆ°Xcodeé¡¹ç›®æ–‡ä»¶"
          exit 1
        fi

    - name: Setup CocoaPods
      env:
        NO_FLIPPER: 1
      run: |
        cd ios
        rm -f Podfile.lock
        rm -rf Pods

        sudo gem install cocoapods
        pod install --verbose

    - name: Build with Auto-detected Scheme
      run: |
        cd ios

        # è·å–ç¬¬ä¸€ä¸ªå¯ç”¨çš„scheme
        if [ "$USE_WORKSPACE" = "true" ]; then
          SCHEME=$(xcodebuild -workspace ABCBankApp.xcworkspace -list | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -1 | xargs)
          echo "ğŸ¯ ä½¿ç”¨workspaceå’Œscheme: $SCHEME"

          xcodebuild -workspace ABCBankApp.xcworkspace \
                     -scheme "$SCHEME" \
                     -configuration Release \
                     -destination 'platform=iOS Simulator,name=iPhone 14' \
                     -derivedDataPath ./build \
                     ONLY_ACTIVE_ARCH=NO \
                     CODE_SIGNING_ALLOWED=NO \
                     build
        else
          SCHEME=$(xcodebuild -project ABCBankApp.xcodeproj -list | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -1 | xargs)
          echo "ğŸ¯ ä½¿ç”¨projectå’Œscheme: $SCHEME"

          xcodebuild -project ABCBankApp.xcodeproj \
                     -scheme "$SCHEME" \
                     -configuration Release \
                     -destination 'platform=iOS Simulator,name=iPhone 14' \
                     -derivedDataPath ./build \
                     ONLY_ACTIVE_ARCH=NO \
                     CODE_SIGNING_ALLOWED=NO \
                     build
        fi

    - name: Find and Package App
      run: |
        cd ios

        echo "ğŸ” æœç´¢æ„å»ºçš„åº”ç”¨..."
        find ./build -name "*.app" -type d

        APP_PATH=$(find ./build -name "*.app" -type d | head -1)

        if [ -n "$APP_PATH" ]; then
          echo "âœ… æ‰¾åˆ°åº”ç”¨: $APP_PATH"

          # æ£€æŸ¥åº”ç”¨å†…å®¹
          echo "ğŸ“± åº”ç”¨å†…å®¹:"
          ls -la "$APP_PATH"

          # æ£€æŸ¥åº”ç”¨å¤§å°
          du -sh "$APP_PATH"

          # æ‰“åŒ…åº”ç”¨
          cd $(dirname "$APP_PATH")
          APP_NAME=$(basename "$APP_PATH")
          zip -r "ABCBankApp-AutoDetect.zip" "$APP_NAME"

          echo "ğŸ“¦ åº”ç”¨æ‰“åŒ…å®Œæˆ: ABCBankApp-AutoDetect.zip"
          ls -la "ABCBankApp-AutoDetect.zip"

          # ç§»åŠ¨åˆ°æ ¹ç›®å½•
          mv "ABCBankApp-AutoDetect.zip" ../../../
        else
          echo "âŒ æœªæ‰¾åˆ°.appæ–‡ä»¶"
          echo "æ„å»ºç›®å½•å†…å®¹ï¼š"
          find ./build -type f | head -20
        fi

    - name: Upload iOS App
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: iOS-AutoDetect-${{ github.run_number }}
        path: |
          ABCBankApp-AutoDetect.zip
          ios/main.jsbundle
        retention-days: 30

    - name: Build Summary
      if: always()
      run: |
        echo "ğŸ¯ è‡ªåŠ¨æ£€æµ‹æ„å»ºå®Œæˆ!"
        echo "ğŸ“± ä½¿ç”¨äº†é¡¹ç›®ä¸­å®é™…å­˜åœ¨çš„scheme"
        echo ""
        if [ -f "ABCBankApp-AutoDetect.zip" ]; then
          echo "âœ… æ„å»ºæˆåŠŸ! ç”Ÿæˆäº†å®Œæ•´çš„iOSåº”ç”¨"
          echo "ğŸ“± åº”ç”¨åŒ…å«æ‰€æœ‰å¿…è¦çš„React Nativeæ–‡ä»¶"
          echo "ğŸ“‚ ä¸‹è½½Artifactsè·å–åº”ç”¨"
        else
          echo "âš ï¸ æ„å»ºæœªå®Œæˆï¼Œä½†å·²æ˜¾ç¤ºé¡¹ç›®é…ç½®ä¿¡æ¯"
          echo "ğŸ”§ è¯·æ£€æŸ¥æ—¥å¿—ä¸­çš„schemeä¿¡æ¯"
        fi