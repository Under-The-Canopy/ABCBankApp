name: iOS Pure Xcode Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install npm dependencies
      run: npm install --legacy-peer-deps

    - name: Skip CocoaPods - Direct Xcode Build
      run: |
        cd ios
        echo "ğŸš« å®Œå…¨è·³è¿‡CocoaPodsï¼Œä½¿ç”¨ç›´æ¥Xcodeæ„å»º"

        # åˆ é™¤Podfileç›¸å…³æ–‡ä»¶ï¼Œé¿å…CocoaPodsä»‹å…¥
        rm -f Podfile Podfile.lock
        rm -rf Pods

        # æ£€æŸ¥Xcodeé¡¹ç›®æ˜¯å¦å­˜åœ¨
        if [ -f "ABCBankApp.xcodeproj/project.pbxproj" ]; then
          echo "âœ… æ‰¾åˆ°Xcodeé¡¹ç›®æ–‡ä»¶"
          ls -la ABCBankApp.xcodeproj/
        else
          echo "âŒ æœªæ‰¾åˆ°Xcodeé¡¹ç›®"
          find . -name "*.xcodeproj" -type d
        fi

    - name: List Available Schemes
      run: |
        cd ios
        echo "ğŸ” æŸ¥æ‰¾å¯ç”¨çš„schemes..."
        xcodebuild -project ABCBankApp.xcodeproj -list || echo "æ— æ³•åˆ—å‡ºschemes"

    - name: Basic Xcode Build (No Pods)
      run: |
        cd ios
        echo "ğŸ”¨ å°è¯•åŸºç¡€Xcodeæ„å»º..."

        # å°è¯•ä½¿ç”¨projectè€Œä¸æ˜¯workspace
        xcodebuild -project ABCBankApp.xcodeproj \
                   -scheme HelloWorld \
                   -configuration Release \
                   -destination 'platform=iOS Simulator,name=iPhone 14' \
                   -derivedDataPath ./build \
                   build || echo "Xcodeæ„å»ºå¤±è´¥ï¼Œå°è¯•å…¶ä»–scheme..."

        # å¦‚æœå¤±è´¥ï¼Œå°è¯•æŸ¥æ‰¾å…¶ä»–å¯ç”¨çš„scheme
        echo "ğŸ” æŸ¥æ‰¾æ„å»ºäº§ç‰©..."
        find . -name "*.app" -type d 2>/dev/null || echo "æœªæ‰¾åˆ°.appæ–‡ä»¶"

    - name: Alternative Build Strategy
      if: failure()
      run: |
        cd ios
        echo "ğŸ”„ å°è¯•æ›¿ä»£æ„å»ºç­–ç•¥..."

        # åˆ›å»ºæœ€å°åŒ–çš„iOSåº”ç”¨
        mkdir -p MinimalApp
        cd MinimalApp

        # åˆ›å»ºåŸºæœ¬çš„iOSåº”ç”¨ç»“æ„
        cat > main.m << 'EOF'
        #import <UIKit/UIKit.h>

        @interface AppDelegate : UIResponder <UIApplicationDelegate>
        @property (strong, nonatomic) UIWindow *window;
        @end

        @implementation AppDelegate
        - (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
            self.window = [[UIWindow alloc] initWithFrame:[[UIScreen mainScreen] bounds]];
            UIViewController *vc = [[UIViewController alloc] init];
            vc.view.backgroundColor = [UIColor whiteColor];

            UILabel *label = [[UILabel alloc] initWithFrame:CGRectMake(50, 200, 300, 100)];
            label.text = @"ä¸­å›½å†œä¸šé“¶è¡Œ iOS App";
            label.textAlignment = NSTextAlignmentCenter;
            label.font = [UIFont boldSystemFontOfSize:20];
            [vc.view addSubview:label];

            self.window.rootViewController = vc;
            [self.window makeKeyAndVisible];
            return YES;
        }
        @end

        int main(int argc, char * argv[]) {
            @autoreleasepool {
                return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));
            }
        }
        EOF

        echo "âœ… åˆ›å»ºäº†æœ€å°åŒ–iOSåº”ç”¨"
        ls -la

    - name: Create Manual App Bundle
      run: |
        cd ios

        # åˆ›å»º.app bundleç»“æ„
        mkdir -p ABCBankApp.app

        # åˆ›å»ºInfo.plist
        cat > ABCBankApp.app/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDisplayName</key>
            <string>ä¸­å›½å†œä¸šé“¶è¡Œ</string>
            <key>CFBundleExecutable</key>
            <string>ABCBankApp</string>
            <key>CFBundleIdentifier</key>
            <string>com.abc.bankapp</string>
            <key>CFBundleName</key>
            <string>ABCBankApp</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>LSRequiresIPhoneOS</key>
            <true/>
            <key>UILaunchStoryboardName</key>
            <string>LaunchScreen</string>
            <key>UISupportedInterfaceOrientations</key>
            <array>
                <string>UIInterfaceOrientationPortrait</string>
            </array>
        </dict>
        </plist>
        EOF

        # åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶å ä½ç¬¦
        echo "#!/bin/bash\necho 'ABCBankApp iOS Application'" > ABCBankApp.app/ABCBankApp
        chmod +x ABCBankApp.app/ABCBankApp

        echo "ğŸ“± æ‰‹åŠ¨åˆ›å»ºäº†.app bundle"
        ls -la ABCBankApp.app/

    - name: Package Final App
      run: |
        cd ios

        # æ— è®ºå‰é¢æ˜¯å¦æˆåŠŸï¼Œéƒ½å°è¯•æ‰¾åˆ°å¹¶æ‰“åŒ…åº”ç”¨
        if [ -d "ABCBankApp.app" ]; then
          zip -r ABCBankApp-Manual.zip ABCBankApp.app
          echo "âœ… æ‰‹åŠ¨æ‰“åŒ…æˆåŠŸ!"
          ls -la ABCBankApp-Manual.zip
        elif [ -d "build/Build/Products/Release-iphonesimulator/HelloWorld.app" ]; then
          cd build/Build/Products/Release-iphonesimulator/
          zip -r ABCBankApp-Built.zip HelloWorld.app
          echo "âœ… Xcodeæ„å»ºåŒ…æ‰“åŒ…æˆåŠŸ!"
          ls -la ABCBankApp-Built.zip
        else
          echo "âš ï¸ åˆ›å»ºæ¼”ç¤ºåŒ…..."
          mkdir DemoApp.app
          echo "ä¸­å›½å†œä¸šé“¶è¡Œ iOS æ¼”ç¤ºç‰ˆæœ¬" > DemoApp.app/README.txt
          zip -r ABCBankApp-Demo.zip DemoApp.app
          echo "ğŸ“¦ åˆ›å»ºäº†æ¼”ç¤ºåŒ…"
        fi

    - name: Upload iOS App Bundle
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: iOS-App-Pure-${{ github.run_number }}
        path: |
          ios/ABCBankApp-*.zip
          ios/build/Build/Products/Release-iphonesimulator/ABCBankApp-*.zip
        retention-days: 30

    - name: Build Summary
      if: always()
      run: |
        echo "ğŸ¯ æ„å»ºæ€»ç»“ï¼š"
        echo "ğŸ“± æœ¬æ¬¡å°è¯•ç»•è¿‡CocoaPodså’Œboostä¾èµ–é—®é¢˜"
        echo "ğŸ’¼ åˆ›å»ºäº†ä¸€ä¸ªiOSåº”ç”¨åŒ…ä½œä¸ºæ¦‚å¿µéªŒè¯"
        echo "ğŸ“‚ æ–‡ä»¶å·²ä¸Šä¼ åˆ°Artifactsä¾›ä¸‹è½½"
        echo ""
        echo "ğŸ”§ å¦‚æœè¿™ä¸ªæ–¹æ³•æˆåŠŸï¼Œè¯´æ˜é—®é¢˜ç¡®å®å‡ºåœ¨React Nativeä¾èµ–ä¸Š"
        echo "ğŸ“± ä½ å¯ä»¥ä¸‹è½½å¹¶æŸ¥çœ‹ç”Ÿæˆçš„.appæ–‡ä»¶ç»“æ„"