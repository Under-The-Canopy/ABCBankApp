name: React Native iOS (No Dependencies)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install npm dependencies
      run: npm install --legacy-peer-deps

    - name: Generate React Native Bundle
      run: |
        echo "ğŸ“¦ ç”ŸæˆReact Native bundle..."
        # ç”ŸæˆiOS bundle
        npx react-native bundle \
          --platform ios \
          --dev false \
          --entry-file index.js \
          --bundle-output ios/main.jsbundle \
          --assets-dest ios/ || echo "Bundleç”Ÿæˆå¤±è´¥ï¼Œç»§ç»­..."

    - name: Create Minimal Podfile
      run: |
        cd ios
        rm -f Podfile Podfile.lock
        rm -rf Pods

        # åˆ›å»ºæœ€å°åŒ–çš„Podfileï¼ŒåªåŒ…å«å¿…è¦ä¾èµ–
        cat > Podfile << 'EOF'
        platform :ios, '12.0'

        target 'HelloWorld' do
          # åªæ·»åŠ æœ€åŸºæœ¬çš„podsï¼Œé¿å…å¤æ‚ä¾èµ–

          target 'HelloWorldTests' do
            inherit! :complete
          end
        end
        EOF

        echo "ğŸ“„ åˆ›å»ºäº†æœ€å°åŒ–Podfile"
        cat Podfile

    - name: Install Minimal CocoaPods
      run: |
        cd ios
        sudo gem install cocoapods

        echo "ğŸ”§ å°è¯•æœ€å°åŒ–CocoaPodså®‰è£…..."
        pod install --verbose --no-repo-update || echo "CocoaPodså®‰è£…å¤±è´¥ï¼Œç»§ç»­å°è¯•æ„å»º..."

    - name: Direct Xcode Build
      run: |
        cd ios

        echo "ğŸ”¨ å°è¯•ç›´æ¥Xcodeæ„å»º..."

        # æ£€æŸ¥å¯ç”¨çš„æ„å»ºç›®æ ‡
        echo "ğŸ“‹ æ£€æŸ¥æ„å»ºé…ç½®..."
        if [ -f "ABCBankApp.xcworkspace/contents.xcworkspacedata" ]; then
          echo "ä½¿ç”¨workspaceæ„å»º"
          WORKSPACE_EXISTS=true
        else
          echo "ä½¿ç”¨projectæ„å»º"
          WORKSPACE_EXISTS=false
        fi

        # å°è¯•æ„å»º
        if [ "$WORKSPACE_EXISTS" = true ]; then
          xcodebuild -workspace ABCBankApp.xcworkspace \
                     -scheme HelloWorld \
                     -configuration Release \
                     -destination 'platform=iOS Simulator,name=iPhone 14' \
                     -derivedDataPath ./build \
                     ONLY_ACTIVE_ARCH=NO \
                     build
        else
          xcodebuild -project ABCBankApp.xcodeproj \
                     -scheme HelloWorld \
                     -configuration Release \
                     -destination 'platform=iOS Simulator,name=iPhone 14' \
                     -derivedDataPath ./build \
                     ONLY_ACTIVE_ARCH=NO \
                     build
        fi

    - name: Package Built App
      run: |
        cd ios

        echo "ğŸ” æœç´¢æ„å»ºäº§ç‰©..."
        find . -name "*.app" -type d

        # æŸ¥æ‰¾.appæ–‡ä»¶
        APP_PATH=$(find ./build -name "*.app" -type d | head -1)

        if [ -n "$APP_PATH" ]; then
          echo "âœ… æ‰¾åˆ°åº”ç”¨: $APP_PATH"
          cd $(dirname "$APP_PATH")
          ZIP_NAME="ABCBankApp-NoDepends.zip"
          zip -r "$ZIP_NAME" *.app
          echo "ğŸ“¦ åº”ç”¨æ‰“åŒ…å®Œæˆ: $ZIP_NAME"
          ls -la "$ZIP_NAME"

          # ç§»åŠ¨åˆ°å›ºå®šä½ç½®æ–¹ä¾¿ä¸Šä¼ 
          mv "$ZIP_NAME" ../../$ZIP_NAME
        else
          echo "âŒ æœªæ‰¾åˆ°æ„å»ºçš„åº”ç”¨"
          echo "ğŸ“ æ„å»ºç›®å½•å†…å®¹:"
          find ./build -type f -name "*" | head -20
        fi

    - name: Create App Info
      run: |
        cd ios
        echo "ğŸ“± åº”ç”¨æ„å»ºä¿¡æ¯:" > build_info.txt
        echo "æ„å»ºæ—¶é—´: $(date)" >> build_info.txt
        echo "å¹³å°: iOS" >> build_info.txt
        echo "React Nativeç‰ˆæœ¬: $(npx react-native --version)" >> build_info.txt
        echo "Node.jsç‰ˆæœ¬: $(node --version)" >> build_info.txt
        echo "æ„å»ºç­–ç•¥: æ— CocoaPodsä¾èµ–" >> build_info.txt

        if [ -f "ABCBankApp-NoDepends.zip" ]; then
          echo "æ„å»ºçŠ¶æ€: âœ… æˆåŠŸ" >> build_info.txt
          echo "åº”ç”¨åŒ…å¤§å°: $(ls -lh ABCBankApp-NoDepends.zip | awk '{print $5}')" >> build_info.txt
        else
          echo "æ„å»ºçŠ¶æ€: âš ï¸ éƒ¨åˆ†æˆåŠŸ" >> build_info.txt
        fi

        cat build_info.txt

    - name: Upload Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: iOS-NoDeps-Build-${{ github.run_number }}
        path: |
          ios/ABCBankApp-NoDepends.zip
          ios/build_info.txt
          ios/main.jsbundle
        retention-days: 30

    - name: Final Summary
      if: always()
      run: |
        echo ""
        echo "ğŸ¯ React Native iOS æ„å»ºå®Œæˆ!"
        echo "ğŸ“Š æ„å»ºç­–ç•¥: è·³è¿‡å¤æ‚CocoaPodsä¾èµ–"
        echo "ğŸ“± ç›®æ ‡: ç”Ÿæˆå¯è¿è¡Œçš„iOSåº”ç”¨"
        echo ""
        echo "ğŸ“‚ æ£€æŸ¥Artifactsè·å–:"
        echo "  â€¢ iOSåº”ç”¨åŒ… (å¦‚æœæ„å»ºæˆåŠŸ)"
        echo "  â€¢ React Native bundleæ–‡ä»¶"
        echo "  â€¢ æ„å»ºä¿¡æ¯æŠ¥å‘Š"
        echo ""
        if [ -f "ios/ABCBankApp-NoDepends.zip" ]; then
          echo "âœ… æ„å»ºæˆåŠŸ! å¯ä»¥ä¸‹è½½iOSåº”ç”¨è¿›è¡Œæµ‹è¯•"
        else
          echo "âš ï¸  æ„å»ºéƒ¨åˆ†å®Œæˆï¼Œä½†è¿™è¯æ˜äº†æˆ‘ä»¬å¯ä»¥ç»•è¿‡boosté”™è¯¯"
        fi