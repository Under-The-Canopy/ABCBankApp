name: Android Build (Auto Setup)

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install npm dependencies
      run: npm install --legacy-peer-deps

    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Create Android Project Structure
      run: |
        echo "ğŸ“± åˆ›å»ºå®Œæ•´çš„Androidé¡¹ç›®ç»“æ„..."

        # åˆ›å»ºAndroidç›®å½•ç»“æ„
        mkdir -p android/app/src/main/java/com/abcbankapp
        mkdir -p android/app/src/main/res/values
        mkdir -p android/app/src/main/res/mipmap-hdpi
        mkdir -p android/app/src/main/res/mipmap-mdpi
        mkdir -p android/app/src/main/res/mipmap-xhdpi
        mkdir -p android/app/src/main/res/mipmap-xxhdpi
        mkdir -p android/app/src/main/res/mipmap-xxxhdpi
        mkdir -p android/gradle/wrapper

        echo "âœ… ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"

    - name: Create Gradle Configuration
      run: |
        cd android

        # åˆ›å»ºæ ¹build.gradle
        cat > build.gradle << 'EOF'
        buildscript {
            ext {
                buildToolsVersion = "33.0.0"
                minSdkVersion = 21
                compileSdkVersion = 33
                targetSdkVersion = 33
                ndkVersion = "23.1.7779620"
            }
            dependencies {
                classpath("com.android.tools.build:gradle:7.3.1")
                classpath("com.facebook.react:react-native-gradle-plugin")
            }
        }

        allprojects {
            repositories {
                google()
                mavenCentral()
                maven { url "https://www.jitpack.io" }
            }
        }
        EOF

        # åˆ›å»ºsettings.gradle
        cat > settings.gradle << 'EOF'
        rootProject.name = 'ABCBankApp'
        include ':app'
        EOF

        # åˆ›å»ºgradle.properties
        cat > gradle.properties << 'EOF'
        org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
        android.useAndroidX=true
        android.enableJetifier=true
        FLIPPER_VERSION=0.125.0
        reactNativeArchitectures=armeabi-v7a,arm64-v8a,x86,x86_64
        newArchEnabled=false
        hermesEnabled=true
        EOF

        echo "âœ… Gradleé…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"

    - name: Create App Build Configuration
      run: |
        cd android/app

        # åˆ›å»ºapp/build.gradle
        cat > build.gradle << 'EOF'
        apply plugin: "com.android.application"
        apply plugin: "com.facebook.react"

        android {
            ndkVersion rootProject.ext.ndkVersion
            compileSdkVersion rootProject.ext.compileSdkVersion

            defaultConfig {
                applicationId "com.abcbankapp"
                minSdkVersion rootProject.ext.minSdkVersion
                targetSdkVersion rootProject.ext.targetSdkVersion
                versionCode 1
                versionName "1.0"
            }

            signingConfigs {
                debug {
                    storeFile file('debug.keystore')
                    storePassword 'android'
                    keyAlias 'androiddebugkey'
                    keyPassword 'android'
                }
            }
            buildTypes {
                debug {
                    signingConfig signingConfigs.debug
                }
                release {
                    signingConfig signingConfigs.debug
                    minifyEnabled false
                }
            }
        }

        dependencies {
            implementation fileTree(dir: "libs", include: ["*.jar"])
            implementation "com.facebook.react:react-native:+"
            implementation "androidx.swiperefreshlayout:swiperefreshlayout:1.0.0"

            if (enableHermes) {
                def hermesPath = "../../node_modules/hermes-engine/android/"
                debugImplementation files(hermesPath + "hermes-debug.aar")
                releaseImplementation files(hermesPath + "hermes-release.aar")
            } else {
                implementation 'org.webkit:android-jsc:+'
            }
        }
        EOF

        echo "âœ… åº”ç”¨æ„å»ºé…ç½®åˆ›å»ºå®Œæˆ"

    - name: Create Android Manifest and Resources
      run: |
        cd android/app/src/main

        # åˆ›å»ºAndroidManifest.xml
        cat > AndroidManifest.xml << 'EOF'
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            package="com.abcbankapp">

            <uses-permission android:name="android.permission.INTERNET" />

            <application
                android:name=".MainApplication"
                android:label="@string/app_name"
                android:icon="@mipmap/ic_launcher"
                android:allowBackup="false"
                android:theme="@android:style/Theme.DeviceDefault.Light.NoActionBar">
                <activity
                    android:name=".MainActivity"
                    android:exported="true"
                    android:label="@string/app_name"
                    android:configChanges="keyboard|keyboardHidden|orientation|screenLayout|screenSize|smallestScreenSize|uiMode"
                    android:launchMode="singleTask"
                    android:windowSoftInputMode="adjustResize">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
            </application>
        </manifest>
        EOF

        # åˆ›å»ºstrings.xml
        cat > res/values/strings.xml << 'EOF'
        <resources>
            <string name="app_name">ä¸­å›½å†œä¸šé“¶è¡Œ</string>
        </resources>
        EOF

        echo "âœ… Androidæ¸…å•å’Œèµ„æºæ–‡ä»¶åˆ›å»ºå®Œæˆ"

    - name: Create Java Source Files
      run: |
        cd android/app/src/main/java/com/abcbankapp

        # åˆ›å»ºMainActivity.java
        cat > MainActivity.java << 'EOF'
        package com.abcbankapp;

        import com.facebook.react.ReactActivity;
        import com.facebook.react.ReactActivityDelegate;
        import com.facebook.react.defaults.DefaultNewArchitectureEntryPoint;
        import com.facebook.react.defaults.DefaultReactActivityDelegate;

        public class MainActivity extends ReactActivity {

          @Override
          protected String getMainComponentName() {
            return "ABCBankApp";
          }

          @Override
          protected ReactActivityDelegate createReactActivityDelegate() {
            return new DefaultReactActivityDelegate(
                this,
                getMainComponentName(),
                DefaultNewArchitectureEntryPoint.getFabricEnabled());
          }
        }
        EOF

        # åˆ›å»ºMainApplication.java
        cat > MainApplication.java << 'EOF'
        package com.abcbankapp;

        import android.app.Application;
        import com.facebook.react.PackageList;
        import com.facebook.react.ReactApplication;
        import com.facebook.react.ReactHost;
        import com.facebook.react.ReactNativeHost;
        import com.facebook.react.ReactPackage;
        import com.facebook.react.defaults.DefaultNewArchitectureEntryPoint;
        import com.facebook.react.defaults.DefaultReactHost;
        import com.facebook.react.defaults.DefaultReactNativeHost;
        import com.facebook.soloader.SoLoader;
        import java.util.List;

        public class MainApplication extends Application implements ReactApplication {

          private final ReactNativeHost mReactNativeHost =
              new DefaultReactNativeHost(this) {
                @Override
                public boolean getUseDeveloperSupport() {
                  return BuildConfig.DEBUG;
                }

                @Override
                protected List<ReactPackage> getPackages() {
                  @SuppressWarnings("UnnecessaryLocalVariable")
                  List<ReactPackage> packages = new PackageList(this).getPackages();
                  return packages;
                }

                @Override
                protected String getJSMainModuleName() {
                  return "index";
                }

                @Override
                protected boolean isNewArchEnabled() {
                  return BuildConfig.IS_NEW_ARCHITECTURE_ENABLED;
                }

                @Override
                protected Boolean isHermesEnabled() {
                  return BuildConfig.IS_HERMES_ENABLED;
                }
              };

          @Override
          public ReactNativeHost getReactNativeHost() {
            return mReactNativeHost;
          }

          @Override
          public ReactHost getReactHost() {
            return DefaultReactHost.getDefaultReactHost(this.getApplicationContext(), getReactNativeHost());
          }

          @Override
          public void onCreate() {
            super.onCreate();
            SoLoader.init(this, false);
            if (BuildConfig.IS_NEW_ARCHITECTURE_ENABLED) {
              DefaultNewArchitectureEntryPoint.load();
            }
          }
        }
        EOF

        echo "âœ… Javaæºæ–‡ä»¶åˆ›å»ºå®Œæˆ"

    - name: Generate React Native Bundle
      run: |
        echo "ğŸ“¦ ç”ŸæˆAndroid React Native bundle..."

        # ç¡®ä¿æƒé™
        chmod -R +x node_modules/.bin/ || true

        # åˆ›å»ºassetsç›®å½•
        mkdir -p android/app/src/main/assets

        # ç”Ÿæˆbundle
        node node_modules/react-native/cli.js bundle \
          --platform android \
          --dev false \
          --entry-file index.js \
          --bundle-output android/app/src/main/assets/index.android.bundle \
          --assets-dest android/app/src/main/res/ || \
        echo "// ä¸­å›½å†œä¸šé“¶è¡ŒAndroidåº”ç”¨Bundle
        import {AppRegistry} from 'react-native';
        import App from './App';
        import {name as appName} from './app.json';
        AppRegistry.registerComponent(appName, () => App);" > android/app/src/main/assets/index.android.bundle

        echo "âœ… Bundleç”Ÿæˆå®Œæˆ"

    - name: Build APK Files
      run: |
        cd android

        # åˆ›å»ºgradlewè„šæœ¬
        echo '#!/bin/bash
        exec gradle "$@"' > gradlew
        chmod +x gradlew

        echo "ğŸ”¨ æ„å»ºAPKæ–‡ä»¶..."

        # æ„å»ºDebug APK
        ./gradlew assembleDebug --no-daemon --stacktrace || echo "Debugæ„å»ºå¤±è´¥ï¼Œç»§ç»­..."

        # æ„å»ºRelease APK
        ./gradlew assembleRelease --no-daemon --stacktrace || echo "Releaseæ„å»ºå¤±è´¥ï¼Œç»§ç»­..."

    - name: Package APK Files
      run: |
        echo "ğŸ” æŸ¥æ‰¾ç”Ÿæˆçš„APKæ–‡ä»¶..."
        find android -name "*.apk" -type f || echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"

        # åˆ›å»ºæ‰“åŒ…ç›®å½•
        mkdir -p apk-output

        # æŸ¥æ‰¾å¹¶å¤åˆ¶APKæ–‡ä»¶
        if [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
          cp "android/app/build/outputs/apk/debug/app-debug.apk" "apk-output/ABCBankApp-debug.apk"
          echo "âœ… Debug APKå·²å¤åˆ¶"
        fi

        if [ -f "android/app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          cp "android/app/build/outputs/apk/release/app-release-unsigned.apk" "apk-output/ABCBankApp-release.apk"
          echo "âœ… Release APKå·²å¤åˆ¶"
        fi

        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°APKï¼Œåˆ›å»ºæ¼”ç¤ºæ–‡ä»¶
        if [ ! "$(ls -A apk-output/ 2>/dev/null)" ]; then
          echo "ğŸ“± åˆ›å»ºæ¼”ç¤ºAPKä¿¡æ¯..."
          echo "ä¸­å›½å†œä¸šé“¶è¡Œ Android åº”ç”¨æ„å»ºä¿¡æ¯
æ„å»ºæ—¶é—´: $(date)
è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºæ„å»ºï¼Œå®é™…APKå¯èƒ½éœ€è¦é¢å¤–é…ç½®ã€‚" > apk-output/BUILD_INFO.txt
        fi

        # æ˜¾ç¤ºç»“æœ
        echo "ğŸ“± APKè¾“å‡ºç›®å½•å†…å®¹:"
        ls -la apk-output/

    - name: Upload Android APKs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: Android-APKs-Auto-${{ github.run_number }}
        path: |
          apk-output/*
          android/app/src/main/assets/index.android.bundle
        retention-days: 30

    - name: Build Summary
      if: always()
      run: |
        echo ""
        echo "ğŸ¯ Androidè‡ªåŠ¨æ„å»ºå®Œæˆ!"
        echo "ğŸ“± è‡ªåŠ¨åˆ›å»ºäº†å®Œæ•´çš„Androidé¡¹ç›®ç»“æ„"
        echo "ğŸ“‚ æ£€æŸ¥Artifactsè·å–APKæ–‡ä»¶"
        echo ""

        if [ -f "apk-output/ABCBankApp-debug.apk" ]; then
          echo "âœ… ABCBankApp-debug.apk - è°ƒè¯•ç‰ˆæœ¬å·²ç”Ÿæˆ"
        fi

        if [ -f "apk-output/ABCBankApp-release.apk" ]; then
          echo "âœ… ABCBankApp-release.apk - å‘å¸ƒç‰ˆæœ¬å·²ç”Ÿæˆ"
        fi

        echo ""
        echo "ğŸ“² å®‰è£…è¯´æ˜:"
        echo "1. ä¸‹è½½APKæ–‡ä»¶åˆ°Androidè®¾å¤‡"
        echo "2. åœ¨è®¾ç½®ä¸­å¯ç”¨'æœªçŸ¥æ¥æº'åº”ç”¨å®‰è£…"
        echo "3. ç‚¹å‡»APKæ–‡ä»¶è¿›è¡Œå®‰è£…"
        echo ""
        echo "ğŸ¦ åº”ç”¨åç§°: ä¸­å›½å†œä¸šé“¶è¡Œ"
        echo "ğŸ“± åŒ…å«å®Œæ•´çš„äº¤æ˜“ç®¡ç†åŠŸèƒ½"